<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Deployment - Documentation - API Umbrella</title>
    <link href="../../stylesheets/all-92746e79.css" rel="stylesheet" type="text/css" />
    <script src="../../javascripts/all-992d4073.js" type="text/javascript"></script>
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Raleway:400,300,700" rel="stylesheet" type="text/css">

    <link rel="canonical" href="http://apiumbrella.io/docs/deployment/" />
    <script>
      if(window.location.href.indexOf('nrel.github.io') !== -1) {
        window.location.href = 'http://apiumbrella.io/docs/deployment/';
      }
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42866857-2', 'nrel.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
  <body class="docs docs_deployment docs_deployment_index">
    <div id="navigation" class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><i class="fa fa-umbrella"></i> <b>API Umbrella</b></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class=""><a href="../../">Home</a></li>
            <li class=""><a href="../../download/">Download</a></li>
            <li class="active"><a href="../architecture/">Documentation</a></li>
          </ul>
        </div>
      </div>
    </div>

      <header>
        <div class="container">
          <h1>Deployment</h1>
        </div>
      </header>

      <div class="container">
    <div class="row">
      <nav class="col-md-3">
        <ul>
  <li class="">
    <a href="../architecture/">Architecture</a>
  </li>
  <li class="">
    <a href="../getting-started/">Getting Started</a>
  </li>
  <li class="">
    <a href="../api-keys/">API Keys</a>
  </li>
  <li class="">
    <a href="../backend-headers/">Backend HTTP Headers</a>
  </li>
  <li class="">
    <a href="../caching/">Caching</a>
  </li>
  <li class="">
    <a href="../smtp-configuration/">SMTP Configuration</a>
  </li>
</ul>

<hr>

<div class="nav-section">Programmers' Guide</div>
<ul>
  <li class="">
    <a href="../development-setup/">Development Setup</a>
  </li>
  <li class="active">
    <a href="./">Deploying From Git</a>
  </li>
</ul>

      </nav>
      <div class="col-md-9">
        <h2 id="deploying-from-git">Deploying From Git</h2>

<p>API Umbrella should be installed onto servers using the <a href="../../download/">download packages</a>. However, if you want to deploy more recent updates from master (or your own forked changes) to the <a href="https://github.com/NREL/api-umbrella-router">api-umbrella-router</a> or <a href="https://github.com/NREL/api-umbrella-web">api-umbrella-web</a> components, then newer versions of those components can be deployed on top of a package-based installation. Deployments are automated through <a href="http://capistranorb.com">Capistrano</a>.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>In order to run the deployment scripts, your local computer (or wherever you're deploying from) must have:</p>

<ul>
  <li>git</li>
  <li>Ruby 1.9+</li>
  <li>Ruby Bundler</li>
</ul>

<p>If you have trouble getting any of these setup locally, you can also run deployments from the <a href="../development-setup/">development virtual machine</a>, which includes these dependencies.</p>

<h3 id="first-time-server-setup">First-Time Server Setup</h3>

<p>On each server you wish to deploy to, you must setup SSH keys so that you can deploy as the <code>api-umbrella-deploy</code> user (this user is automatically created as part of the package installation). These steps only need to be performed once per server.</p>

<h4 id="pre-api-umbrella-version-07">Pre API Umbrella Version 0.7</h4>

<ul>
  <li>
    <p>For API Umbrella installations prior to version 0.7, some adjustment need to be made on each server to the <code>api-umbrella-deploy</code> account that was created during installation. Follow these steps once on each server where you have installed API Umbrella v0.6 or less:</p>

<pre class="highlight shell"><code><span class="gp">$ </span>sudo usermod -d /home/api-umbrella-deploy -s /bin/bash api-umbrella-deploy
<span class="gp">$ </span>sudo mkdir -p /home/api-umbrella-deploy/.ssh
<span class="gp">$ </span>sudo touch /home/api-umbrella-deploy/.ssh/authorized_keys
<span class="gp">$ </span>sudo chown -R api-umbrella-deploy:api-umbrella-deploy /home/api-umbrella-deploy
<span class="gp">$ </span>sudo chmod 700 /home/api-umbrella-deploy /home/api-umbrella-deploy/.ssh
<span class="gp">$ </span>sudo chmod 600 /home/api-umbrella-deploy/.ssh/authorized_keys
</code></pre>
  </li>
</ul>

<h4 id="on-your-computer">On Your Computer</h4>

<ul>
  <li>Ensure you have SSH keys: You must have SSH keys setup on your local computer (or wherever you're deploying from). If you do not have SSH keys, see steps 1 &amp; 2 from GitHub's <a href="https://help.github.com/articles/generating-ssh-keys/">Generating SSH keys</a> guide for instructions.</li>
  <li>Copy your public key: Copy the contents of your public key (often at <code>~/.ssh/id_rsa.pub</code>). For more tips on copying, or alternative locations for your public key, see step 3 from GitHub's <a href="https://help.github.com/articles/generating-ssh-keys/#step-3-add-your-ssh-key-to-your-account">Generating SSH keys</a> guide.</li>
</ul>

<h4 id="on-each-server">On Each Server</h4>

<ul>
  <li>
    <p>With your public SSH key in hand from your own computer, follow these steps on each server, replacing <code>YOUR_PUBLIC_KEY</code> as appropriate:</p>

<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">echo</span> <span class="s2">"YOUR_PUBLIC_KEY"</span> | sudo tee --append /home/api-umbrella-deploy/.ssh/authorized_keys
</code></pre>
  </li>
</ul>

<h3 id="deploying-api-umbrella-router">Deploying api-umbrella-router</h3>

<ul>
  <li>First-time setup:
    <ul>
      <li>
        <p>Check out the <a href="https://github.com/NREL/api-umbrella-router">api-umbrella-router</a> repository from git:</p>

<pre class="highlight shell"><code><span class="gp">$ </span>git clone https://github.com/NREL/api-umbrella-router.git router
</code></pre>
      </li>
      <li>
        <p>Install the deployment dependencies:</p>

<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">cd </span>router
<span class="gp">$ </span>bundle install
</code></pre>
      </li>
      <li>
        <p>Define your destination servers: Add a <code>.env</code> file inside the <code>router</code> directory defining the servers to deploy to for the "staging" or "production" environments:</p>

<pre class="highlight plaintext"><code>API_UMBRELLA_STAGING_ROUTER_SERVERS="10.0.0.1,10.0.0.2"
API_UMBRELLA_PRODUCTION_ROUTER_SERVERS="10.0.10.1,10.0.10.2"
</code></pre>

        <p>Servers can be defined using hostnames or IP address. Multiple servers can be comma-delimited. In this example there are two staging servers (<code>10.0.0.1</code> and <code>10.0.0.2</code>), and two production servers (<code>10.0.10.1</code> and <code>10.0.10.2</code>).</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Deploy to either the "staging" or "production" environments:</p>

<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">cd </span>router
<span class="gp">$ </span>bundle <span class="nb">exec </span>cap staging deploy
<span class="gp">$ </span>bundle <span class="nb">exec </span>cap production deploy
</code></pre>
  </li>
</ul>

<h3 id="deploying-api-umbrella-web">Deploying api-umbrella-web</h3>

<ul>
  <li>First-time setup:
    <ul>
      <li>
        <p>Check out the <a href="https://github.com/NREL/api-umbrella-web">api-umbrella-web</a> repository from git:</p>

<pre class="highlight shell"><code><span class="gp">$ </span>git clone https://github.com/NREL/api-umbrella-web.git web
</code></pre>
      </li>
      <li>
        <p>Install the deployment dependencies:</p>

<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">cd </span>web
<span class="gp">$ </span>bundle install
</code></pre>
      </li>
      <li>
        <p>Define your destination servers: Add a <code>.env</code> file inside the <code>web</code> directory defining the servers to deploy to for the "staging" or "production" environments:</p>

<pre class="highlight plaintext"><code>API_UMBRELLA_STAGING_WEB_SERVERS="10.0.0.1,10.0.0.2"
API_UMBRELLA_PRODUCTION_WEB_SERVERS="10.0.10.1,10.0.10.2"
</code></pre>

        <p>Servers can be defined using hostnames or IP address. Multiple servers can be comma-delimited. In this example there are two staging servers (<code>10.0.0.1</code> and <code>10.0.0.2</code>), and two production servers (<code>10.0.10.1</code> and <code>10.0.10.2</code>).</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Deploy to either the "staging" or "production" environments:</p>

<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">cd </span>web
<span class="gp">$ </span>bundle <span class="nb">exec </span>cap staging deploy
<span class="gp">$ </span>bundle <span class="nb">exec </span>cap production deploy
</code></pre>
  </li>
</ul>

      </div>
    </div>
  </div>


    <div style="text-align: center; font-style: italic; padding: 2em 0.5em;">
      <a href="https://github.com/NREL/api-umbrella/blob/master/website/docs/deployment.md.erb">Help Improve this Content</a>
    </div>
  </body>
</html>
