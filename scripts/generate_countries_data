#!/opt/api-umbrella/bin/api-umbrella-exec resty
-- vi: ft=lua :

local cjson = require "cjson"
local file = require "pl.file"
local lyaml = require "lyaml"
local pretty = require "pl.pretty"
local OrderedMap = require "pl.OrderedMap"

local handle = io.popen("curl -fsSL https://raw.githubusercontent.com/hexorx/countries/v2.1.2/lib/countries/cache/countries.json")
local result = handle:read("*a")
local data = cjson.decode(result)

local countries = OrderedMap()
for key, value in pairs(data) do
  countries:set(key, value["name"])
end
countries:sort()

local handle = io.popen("curl -fsSL https://raw.githubusercontent.com/hexorx/countries/v2.1.2/lib/countries/data/subdivisions/US.yaml")
local result = handle:read("*a")
local data = lyaml.load(result)

local subdivisions = {
  US = OrderedMap(),
}
for key, value in pairs(data) do
  subdivisions["US"]:set(key, value["name"])
end
subdivisions["US"]:sort()

local output = [[-- Do not manually edit: Generated by ./scripts/generate_countries_data
-- based on data from https://github.com/hexorx/countries

local _M = {}

_M.countries = ]] .. pretty.write(countries) .. [[


_M.subdivisions = ]] .. pretty.write(subdivisions) .. [[


return _M]]

file.write("src/api-umbrella/web-app/utils/countries.lua", output)
