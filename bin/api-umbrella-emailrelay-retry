#!/usr/bin/env bash

set -e -u

# Kill the child "sleep" processes on exit.
cleanup() {
  local pids
  pids=($(jobs -pr))
  if [ -n "${pids:-}" ]; then
    kill "${pids[@]}"
  fi
}
trap "cleanup" EXIT

if [ -z "${API_UMBRELLA_EMBEDDED_ROOT:-}" ]; then
  echo "Error: API_UMBRELLA_EMBEDDED_ROOT environment variable is not set"
  exit 1
fi

if [ -z "${API_UMBRELLA_EMAILRELAY_SPOOL:-}" ]; then
  echo "Error: API_UMBRELLA_EMAILRELAY_SPOOL environment variable is not set"
  exit 1
fi

frequency=300 # Sleep for 5 minutes between runs

while true; do
  "$API_UMBRELLA_EMBEDDED_ROOT"/libexec/emailrelay/examples/emailrelay-resubmit.sh "$API_UMBRELLA_EMAILRELAY_SPOOL"
  sleep "$frequency"
done
