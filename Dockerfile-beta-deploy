FROM ubuntu:16.04

WORKDIR /
COPY . /app
RUN ls -l /app && mkdir /build && \
  cd /build && \
  set -x && \
  apt-get update && \
  apt-get -y install aptitude && \
  bash -c 'source /app/build/package_dependencies.sh && aptitude -y install "${core_package_dependencies[@]}"' && \
  bash -c 'source /app/build/package_dependencies.sh && aptitude -y --add-user-tag "installed-build-deps" install "${core_build_dependencies[@]}"' && \
  /app/configure && \
  make && \
  make install && \
  make distclean && \
  env SUDO_FORCE_REMOVE=yes aptitude -y --safe-resolver remove '?user-tag(installed-build-deps)' && \
  apt-get -y --purge remove aptitude && \
  apt-get -y --purge autoremove && \
  cd / && \
  rm -rf /build /app && \
  rm -rf /var/lib/apt/lists/*

RUN groupadd -r api-umbrella && \
  useradd -r -g api-umbrella -s /sbin/nologin -d /opt/api-umbrella -c "API Umbrella user" api-umbrella

CMD ["api-umbrella", "run"]
