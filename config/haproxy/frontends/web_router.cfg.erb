frontend web_router
  bind *:80
  bind *:443 ssl crt <%= ssl_cert_pem %> ciphers RC4-SHA:AES128-SHA:AES:!ADH:!aNULL:!DH:!EDH:!eNULL

  # Add a unique ID header to the request, so the request can be tracked
  # through multiple proxies.  
  unique-id-format %{+X}o%ci%cp%fi%fp%Ts%ms%pid%rt%H
  unique-id-header X-ApiUmbrella-UID

  # Custom log format - Like default HTTP log, but includes bytes_uploaded (%U)
  # and unique-id (%ID).
  log-format %ci:%cp\ [%t]\ %ft\ %b/%s\ %Tq/%Tw/%Tc/%Tr/%Tt\ %ST\ %B\ %U\ %CC\ \ %CS\ %tsc\ %ac/%fc/%bc/%sc/%rc\ %sq/%bq\ %ID\ %hr\ %hs\ %{+Q}r

  # Ensure connections are closed for forwardfor compatability.
  option http-server-close

  # Add X-Forwarded-* headers unless we've already passed through WAF.
  option forwardfor

  # ACL rule if the request was HTTPS tunneled through nginx.
  acl via_https ssl_fc

  reqadd X-Forwarded-Proto:\ https if via_https
  reqadd X-Forwarded-Port:\ 443 if via_https

  # Route requests for the static web content.
  acl url_match_web_pages path_reg ^$ ^/$ ^/(about|community|doc|docs|images|static)(/|$)
  use_backend github_pages_farm if url_match_web_pages

  # Route requests for the dynamic web app.
  acl url_match_web_app path_reg ^/(account|admin|admins|assets|contact|signup)(/|$)
  use_backend developer_site_farm if url_match_web_app

  # Requests starting with /auth get sent to Tomcat for our CAS servlet.
  acl url_match_auth path_beg /auth
  use_backend tomcat_farm if via_https url_match_auth

  # Requests starting with /backstage get sent to the Torquebox backstage
  # admin.
  acl url_match_backstage path_beg /backstage
  use_backend torquebox_farm if url_match_backstage

  # All other requests are assumed to be API requests, so they go to the
  # gatekeeper.
  default_backend gatekeeper_farm

  # Remove server versioning headers per Cyber.
  #
  # Phusion Passenger seems to kill the ability for nginx to remove this
  # itself: http://code.google.com/p/phusion-passenger/issues/detail?id=289
  rspidel ^Server:.*
  rspidel ^X-Powered-By:.*
