frontend web_router
  bind *:80 # Public HTTP traffic
  bind *:81 # HTTPS traffic tunneled through nginx

  # Ensure connections are closed for forwardfor compatability.
  option http-server-close

  # Add X-Forwarded-* headers unless we've already passed through WAF.
  option forwardfor except 192.174.58.16/31

  acl has_forwarded_proto hdr_cnt(X-Forwarded-Proto) gt 0
  reqadd X-Forwarded-Proto:\ http unless has_forwarded_proto

  acl has_forwarded_port hdr_cnt(X-Forwarded-Port) gt 0
  reqadd X-Forwarded-Port:\ 80 unless has_forwarded_port

  # ACL rule if the request was HTTPS tunneled through nginx.
  acl via_https dst_port eq 81

  <% if(rails_env == "development") %>
  # chef.devdev.nrel.gov
  acl host_match_chef hdr_beg(host) -i chef.
  use_backend devdev_chef_farm if host_match_chef

  # chefweb.devdev.nrel.gov
  acl host_match_chefweb hdr_beg(host) -i chefweb.
  use_backend devdev_chefweb_farm if host_match_chefweb

  # opsview.devdev.nrel.gov
  acl host_match_opsview hdr_beg(host) -i opsview.
  use_backend apache_farm if host_match_opsview

  # docs.devdev.nrel.gov
  acl host_match_docs hdr_beg(host) -i docs.
  use_backend devdev_docs_farm if host_match_docs
  <% end %>

  # Requests starting with /api/ get sent to the auth proxy for authentication
  # and rate limiting.
  acl url_match_api path_beg /api/
  use_backend auth_proxy_farm if url_match_api

  # Requests starting with /auth get sent to Tomcat for our CAS servlet.
  acl url_match_auth path_beg /auth
  use_backend tomcat_farm if via_https url_match_auth

  # All other requests go to our main site.
  default_backend developer_site_farm

  # Remove server versioning headers per Cyber.
  #
  # Phusion Passenger seems to kill the ability for nginx to remove this
  # itself: http://code.google.com/p/phusion-passenger/issues/detail?id=289
  rspidel ^Server:.*
  rspidel ^X-Powered-By:.*
