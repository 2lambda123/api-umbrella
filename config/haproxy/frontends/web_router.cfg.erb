frontend web_router
  bind *:80
  bind *:443 ssl crt <%= ssl_cert_pem %> ciphers RC4-SHA:AES128-SHA:AES:!ADH:!aNULL:!DH:!EDH:!eNULL

  # Add a unique ID header to the request, so the request can be tracked
  # through multiple proxies.  
  unique-id-format %{+X}o%ci%cp%fi%fp%Ts%ms%pid%rt%H
  unique-id-header X-ApiUmbrella-UID

  # Custom log format - Like default HTTP log, but includes bytes_uploaded (%U)
  # and unique-id (%ID).
  log-format %ci:%cp\ [%t]\ %ft\ %b/%s\ %Tq/%Tw/%Tc/%Tr/%Tt\ %ST\ %B\ %U\ %CC\ \ %CS\ %tsc\ %ac/%fc/%bc/%sc/%rc\ %sq/%bq\ %ID\ %hr\ %hs\ %{+Q}r

  # Ensure connections are closed for forwardfor compatability.
  option http-server-close

  # Add X-Forwarded-* headers unless we've already passed through WAF.
  option forwardfor

  # ACL rule if the request was HTTPS tunneled through nginx.
  acl via_https ssl_fc

  reqadd X-Forwarded-Proto:\ https if via_https
  reqadd X-Forwarded-Port:\ 443 if via_https

  # Requests starting with /api/ get sent to the gatekeeper for access control
  # and rate limiting.
  acl url_match_api path_beg /api/
  use_backend gatekeeper_farm if url_match_api

  # Requests starting with /auth get sent to Tomcat for our CAS servlet.
  acl url_match_auth path_beg /auth
  use_backend tomcat_farm if via_https url_match_auth

  # All other requests go to our main site.
  default_backend developer_site_farm

  # Remove server versioning headers per Cyber.
  #
  # Phusion Passenger seems to kill the ability for nginx to remove this
  # itself: http://code.google.com/p/phusion-passenger/issues/detail?id=289
  rspidel ^Server:.*
  rspidel ^X-Powered-By:.*
