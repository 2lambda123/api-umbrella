[unix_http_server]
file={{run_dir}}/supervisor.sock

[inet_http_server]
port=*:9009

[supervisord]
pidfile={{run_dir}}/supervisord.pid
logfile={{log_dir}}/supervisor/supervisord.log
logfile_maxbytes=0
childlogdir={{log_dir}}/supervisor

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[rpcinterface:laforge]
supervisor.rpcinterface_factory = mr.laforge.rpcinterface:make_laforge_rpcinterface

[ctlplugin:laforge]
supervisor.ctl_factory = mr.laforge.controllerplugin:make_laforge_controllerplugin

[ctlplugin:serialrestart]
supervisor.ctl_factory = supervisorserialrestart.controllerplugin:make_serialrestart_controllerplugin

[supervisorctl]
serverurl=unix://{{run_dir}}/supervisor.sock

[program:mongod]
command=mongod --config {{config_dir}}/mongod.conf
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:elasticsearch]
environment=ES_INCLUDE="{{config_dir}}/elasticsearch/elasticsearch-env.sh"
command=elasticsearch
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:redis]
command=redis-server {{config_dir}}/redis.conf
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:varnishd]
command=varnishd -F -a :{{varnish.port}} -f {{config_dir}}/varnish.vcl -t 0 -n {{run_dir}}/varnish/api-umbrella -p http_gzip_support=off
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:varnishlog]
command=varnishlog -a -w {{log_dir}}/varnish.log -n {{run_dir}}/varnish/api-umbrella
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:varnishncsa]
command=varnishncsa -a -w {{log_dir}}/varnishncsa.log -n {{run_dir}}/varnish/api-umbrella
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:nginx-router]
command=nginx -c {{config_dir}}/nginx/router.conf
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:gatekeeper]
numprocs=4
process_name=%(program_name)s_50%(process_num)03d
command=api-umbrella-gatekeeper {{api_umbrella_config_args}} -p 50%(process_num)03d
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s_50%(process_num)03d.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:config-reloader]
command=api-umbrella-config-reloader {{api_umbrella_config_args}}
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:router-log-listener]
command=api-umbrella-router-log-listener {{api_umbrella_config_args}}
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:log-processor]
command=api-umbrella-log-processor {{api_umbrella_config_args}}
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:distributed-rate-limits-sync]
command=api-umbrella-distributed-rate-limits-sync {{api_umbrella_config_args}}
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

{{#if development_env}}
[program:static-site]
directory=/vagrant/workspace/static-site
command=bundle exec middleman server -p {{static_site.port}} --verbose
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3
{{/if}}

[program:web-puma]
environment=MONGODB_URL="{{mongodb.url}}",ELASTICSEARCH_HOSTS="{{elasticsearch.hosts}}"
directory=/vagrant/workspace/web
command=bundle exec puma -q -e {{app_env}} -w {{web.puma.workers}} -t {{web.puma.min_threads}}:{{web.puma.max_threads}} -b unix://{{run_dir}}/web-puma.sock
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3

[program:web-nginx]
command=nginx -c {{config_dir}}/nginx/web.conf
redirect_stderr=true
stdout_logfile={{log_dir}}/supervisor/%(program_name)s.log
stderr_logfile=NONE
logfile_maxbytes=0
startsecs=3
