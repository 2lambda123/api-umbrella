#!/usr/bin/env bash
set -e -u

# Redirect stderr to stdout
exec 2>&1

umask "{{umask}}"

if [ "${1}" = "start" ]; then
  echo "starting ${2}..."
  api_umbrella_user="{{user}}"
  api_umbrella_group="{{group}}"

  PATH="{{_embedded_root_dir}}/elasticsearch/bin:$PATH"
  run_args=("-e" "rc.env")
  if [ -n "$api_umbrella_user" ]; then
    run_args+=("-u" "$api_umbrella_user")
  fi

  cp "{{_embedded_root_dir}}/elasticsearch/config/jvm.options" "{{etc_dir}}/elasticsearch/"
  sed -i 's#=logs/#={{log_dir}}/elasticsearch/#g' "{{etc_dir}}/elasticsearch/jvm.options"

  if [ ! -f "{{etc_dir}}/elasticsearch/elasticsearch.keystore" ]; then
    runtool -e "rc.env" "{{_embedded_root_dir}}/elasticsearch/bin/elasticsearch-keystore" create
  fi

  dirs=("{{db_dir}}/elasticsearch" "{{log_dir}}/elasticsearch")
  mkdir -p "${dirs[@]}"
  chmod 750 "${dirs[@]}"
  chmod 660 "{{etc_dir}}/elasticsearch/elasticsearch.keystore"
  if [ -n "$api_umbrella_user" ]; then
    chown $api_umbrella_user:$api_umbrella_group "${dirs[@]}" "{{etc_dir}}/elasticsearch/elasticsearch.keystore"
  fi

  exec runtool ${run_args[@]+"${run_args[@]}"} elasticsearch
fi

exit 0
