worker_processes {{nginx.workers}};
error_log stderr notice;
daemon off;
pid {{run_dir}}/nginx-web-app.pid;

{{#user}}
user {{user}} {{group}};
{{/user}}

events {
  worker_connections {{nginx.worker_connections}};
}

env API_UMBRELLA_SRC_ROOT;
env API_UMBRELLA_RUNTIME_CONFIG;

pcre_jit on;

http {
  access_log {{log_dir}}/nginx-web-app/{{nginx.access_log_filename}} combined;

  client_body_temp_path {{tmp_dir}}/nginx-web-app-client_body_temp;
  proxy_temp_path {{tmp_dir}}/nginx-web-app-proxy_temp;
  fastcgi_temp_path {{tmp_dir}}/nginx-web-app-fastcgi_temp;
  uwsgi_temp_path {{tmp_dir}}/nginx-web-app-uwsgi_temp;
  scgi_temp_path {{tmp_dir}}/nginx-web-app-scgi_temp;
  server_tokens off;

  lua_package_path '{{_src_root_dir}}/src/api-umbrella/web-app/?.lua;{{_package_path}}';
  lua_package_cpath '{{_package_cpath}}';
  lua_check_client_abort on;
  if_modified_since off;

  lua_shared_dict locks {{nginx.shared_dicts.locks.size}};

  {{#dns_resolver._nameservers_nginx}}
    resolver {{dns_resolver._nameservers_nginx}};
    resolver_timeout 12s;
  {{/dns_resolver._nameservers_nginx}}

  include ./mime.conf;
  include ./realip.conf;

  init_by_lua_file '{{_src_root_dir}}/src/api-umbrella/web-app/hooks/init.lua';

  server {
    listen {{web.host}}:{{web.port}};

    {{#_development_env?}}
      lua_code_cache off;
    {{/_development_env?}}

    # Security headers
    # https://www.owasp.org/index.php/OWASP_Secure_Headers_Project#tab=Headers
    more_set_headers "X-XSS-Protection: 1; mode=block";
    more_set_headers "X-Frame-Options: DENY";
    more_set_headers "X-Content-Type-Options: nosniff";

    rewrite ^/admin$ /admin/ permanent;

    location ~ ^/admin($|/$|/index\.html|/assets/.+|/fonts/.+|/maps/.+|/ember.+) {
      {{^_development_env?}}
        alias {{_embedded_root_dir}}/apps/core/current/build/dist/admin-ui/$1;
      {{/_development_env?}}
      {{#_development_env?}}
        proxy_pass http://127.0.0.1:{{ember_server.port}};
      {{/_development_env?}}
    }

    location /admin/auth-assets/ {
      alias {{_embedded_root_dir}}/apps/core/current/build/dist/admin-auth-assets/;
    }

    location / {
      default_type text/html;
      content_by_lua_block {
        require("lapis").serve("api-umbrella.web-app.app")
      }
    }
  }
}
