dependencies:
  cache_directories:
    - ci_cache
    - node_modules
    - vendor
  pre:
    # Install all the API Umbrella software dependencies.
    - make install PREFIX="$(pwd)/ci_cache/build"

    # Get rid of all the intermediate downloads for building the dependencies.
    - make clean

    # Install the unbound package that's not included with API Umbrella, but
    # needed to run tests. But prevent it from automatically starting up after
    # install at the system level with the RUNLEVEL=1 variable.
    - sudo apt-get update
    - sudo env RUNLEVEL=1 apt-get install unbound

    # Use the mongo-orchestration library for providing a testable replicaset,
    # so we can see how the stack reacts to replicaset re-elections, etc.
    - sudo pip install mongo-orchestration==0.3.1
test:
  override:
    - API_UMBRELLA_ROOT="$(pwd)/ci_cache/build" npm test
