general:
  artifacts:
    # Keep logs after running to help debug if errors do crop up.
    - "/tmp/api-umbrella-test/var/log"
machine:
  pre:
    # Enable IPv6 on CircleCI for running IPv6 integration tests.
    - sudo sysctl -w net.ipv6.conf.lo.disable_ipv6=0 net.ipv6.conf.default.disable_ipv6=0 net.ipv6.conf.all.disable_ipv6=0
dependencies:
  cache_directories:
    - ci_cache
    - node_modules
    - vendor
  pre:
    # Install all the API Umbrella software dependencies.
    - make install --debug PREFIX="$(pwd)/ci_cache/build"
    - make install_test_dependencies --debug PREFIX="$(pwd)/ci_cache/build"

    # Get rid of all the intermediate downloads for building the dependencies.
    - make clean

    # Install the unbound package that's not included with API Umbrella, but
    # needed to run tests. But prevent it from automatically starting up after
    # install at the system level with the RUNLEVEL=1 variable.
    - sudo apt-get update
    - sudo env RUNLEVEL=1 apt-get install unbound

    # Use the mongo-orchestration library for providing a testable replicaset,
    # so we can see how the stack reacts to replicaset re-elections, etc.
    - sudo pip install mongo-orchestration==0.3.1
test:
  override:
    # Run the integration/gatekeeper tests.
    - mkdir -p $CIRCLE_TEST_REPORTS/mocha
    - make test PREFIX="$(pwd)/ci_cache/build"
    - cp test/tmp/xunit.xml $CIRCLE_TEST_REPORTS/mocha/
    # Run the web-app tests.
    - mkdir -p $CIRCLE_TEST_REPORTS/rspec
    # Start the version of elasticsearch bundled with API Umbrella.
    - $(pwd)/ci_cache/build/embedded/bin/elasticsearch:
        background: true
    - bundle exec rake:
        pwd: src/api-umbrella/web-app
        environment:
          PATH: "../../../ci_cache/build/embedded/bin:$PATH"
    - cp src/api-umbrella/web-app/spec/reports/web-app.xml $CIRCLE_TEST_REPORTS/rspec/
experimental:
  notify:
    branches:
      ignore:
        # Ignore the lua branches for now for notification purposes.
        - /lua.*/
