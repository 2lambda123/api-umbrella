#!/usr/bin/env bash

postgresql_version="10.9"
postgresql_hash="958b317fb007e94f3bef7e2a6641875db8f7f9d73db9f283324f3d6e8f5b0f54"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir

download "https://ftp.postgresql.org/pub/source/v$postgresql_version/postgresql-$postgresql_version.tar.bz2" "sha256" "$postgresql_hash"
extract_download "postgresql-$postgresql_version.tar.bz2"

cd "postgresql-$postgresql_version"
./configure \
  --prefix="$INSTALL_PREFIX_EMBEDDED" \
  --disable-rpath \
  --with-system-tzdata=/usr/share/zoneinfo
make -j"$NPROC"
(cd contrib/pgcrypto && make -j"$NPROC")
make install DESTDIR="$STAGE_DIR"
(cd contrib/pgcrypto && make install DESTDIR="$STAGE_DIR")

stamp
