#!/usr/bin/env bash

# PCRE 8.21+ required for OpenResty's JIT regex support.
#
# We can likely drop compiling our own version and use the system version once
# we no longer need to support CentOS 6 (currently on PCRE 7.8).
pcre_version="8.43"
pcre_hash="636222e79e392c3d95dcc545f24f98c4"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir
download "https://ftp.pcre.org/pub/pcre/pcre-$pcre_version.tar.bz2" "md5" "$pcre_hash"
extract_download "pcre-$pcre_version.tar.bz2"

cd "pcre-$pcre_version"
./configure \
  --prefix="$INSTALL_PREFIX_EMBEDDED" \
  --disable-cpp \
  --enable-jit \
  --enable-utf \
  --enable-unicode-properties
make -j"$NPROC"
make install DESTDIR="$STAGE_DIR"
chrpath -d "$STAGE_EMBEDDED_DIR/bin/pcregrep"
chrpath -d "$STAGE_EMBEDDED_DIR/bin/pcretest"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libpcreposix.so"

stamp
