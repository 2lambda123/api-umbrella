#!/usr/bin/env bash

trafficserver_version="8.0.2"
trafficserver_hash="950a3dbac81451bd37576c4fd49db6dba5aca5db20d5d60af5b9ae364a05c1dca09fffd021f56f43536b0599c105f9e8ff0e8cebedb38af28a2129b35cc81fc5"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir
download "https://archive.apache.org/dist/trafficserver/trafficserver-$trafficserver_version.tar.bz2" "sha512" "$trafficserver_hash"
extract_download "trafficserver-$trafficserver_version.tar.bz2"

cd "trafficserver-$trafficserver_version"
SPHINXBUILD=false ./configure \
  --prefix="$INSTALL_PREFIX_EMBEDDED" \
  --with-luajit="$STAGE_EMBEDDED_DIR/openresty/luajit"
make -j"$NPROC"
make install DESTDIR="$STAGE_DIR"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtscore.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtsmgmt.so"
find "$STAGE_EMBEDDED_DIR/libexec/trafficserver/" -name "*.so" -exec chrpath -d {} \;
find "$STAGE_EMBEDDED_DIR/bin/" -name "traffic_*" -exec chrpath -d {} \;

stamp
