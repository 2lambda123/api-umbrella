#!/usr/bin/env bash

haproxy_version="2.4.7"
haproxy_hash="67d28ee9a39973bf17a38563d39ea81e"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir
download "http://www.haproxy.org/download/2.4/src/haproxy-$haproxy_version.tar.gz" "md5" "$haproxy_hash"
extract_download "haproxy-$haproxy_version.tar.gz"

cd "haproxy-$haproxy_version"
make -j"$NPROC" \
  TARGET=linux-glibc \
  USE_OPENSSL=1 \
  USE_SLZ=1 \
  USE_PCRE=1 \
  USE_PCRE_JIT=1
make install DESTDIR="$STAGE_DIR" \
  PREFIX="$INSTALL_PREFIX_EMBEDDED"

stamp
