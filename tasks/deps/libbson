#!/usr/bin/env bash

libbson_version="1.14.0"
libbson_hash="374652f8bd68b89616e35885f7077b97"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir
download "https://github.com/mongodb/mongo-c-driver/releases/download/$libbson_version/mongo-c-driver-$libbson_version.tar.gz" "md5" "$libbson_hash"
extract_download "mongo-c-driver-$libbson_version.tar.gz"

cd "mongo-c-driver-$libbson_version"
mkdir cmake-build
cd cmake-build
cmake -DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -DENABLE_MONGOC=OFF -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX_EMBEDDED" ..
make -j"$NPROC"
DESTDIR="$STAGE_DIR" make install
find "$STAGE_EMBEDDED_DIR/bin/" -name "mongoc*" -exec chrpath -d {} \;

stamp
