#!/usr/bin/env bash

# Use version from master until next version after 1.7.1 is released (then we
# can go back to LuaRocks or OPM installs). Need master for lifecycle hooks
# (https://github.com/zmartzone/lua-resty-openidc/pull/252) and to fix some
# global variable warnings
# (https://github.com/zmartzone/lua-resty-openidc/pull/254).
lua_resty_openidc_version="cdaf824996d2b499de4c72852c91733872137c9c"
lua_resty_openidc_hash="d30a973461e2f1e3762133d546062e06"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir
download "https://github.com/zmartzone/lua-resty-openidc/archive/$lua_resty_openidc_version.tar.gz" "md5" "$lua_resty_openidc_hash"
extract_download "$lua_resty_openidc_version.tar.gz"

cd "lua-resty-openidc-$lua_resty_openidc_version"
"${LUAROCKS_CMD[@]}" --tree="$APP_CORE_VENDOR_LUA_DIR" make --local lua-resty-openidc-1.7.1-1.rockspec

stamp
