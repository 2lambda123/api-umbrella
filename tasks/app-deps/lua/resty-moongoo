#!/usr/bin/env bash

lua_cbson_version="ef488785981bbe3cf41237a2d9857494b73eb135"
lua_cbson_hash="6656e6d991368c644e7dc6809297b89c"

lua_resty_moongoo_version="663f98f03467438f29c9c971c00b063f6f9643ee"
lua_resty_moongoo_hash="7f22180fd641b5a668db212e5694ca02"

set -e -u -x
source ./tasks/helpers.sh

task_working_dir

# lua-cbson dependency
download "https://github.com/isage/lua-cbson/archive/$lua_cbson_version.tar.gz" "md5" "$lua_cbson_hash"
extract_download "$lua_cbson_version.tar.gz"
cd "lua-cbson-$lua_cbson_version"
mkdir cmake-build
cd cmake-build
LUA_DIR="$STAGE_EMBEDDED_DIR/openresty/luajit" CMAKE_PREFIX_PATH="$STAGE_EMBEDDED_DIR" cmake ..
make -j"$NPROC"
chrpath -d cbson.so
install -D -m 644 cbson.so "$APP_CORE_VENDOR_LUA_DIR/lib/lua/5.1/cbson.so"

# lua-resty-moongoo
download "https://github.com/isage/lua-resty-moongoo/archive/$lua_resty_moongoo_version.tar.gz" "md5" "$lua_resty_moongoo_hash"
extract_download "$lua_resty_moongoo_version.tar.gz"
cd "lua-resty-moongoo-$lua_resty_moongoo_version"
mkdir -p "$APP_CORE_VENDOR_LUA_SHARE_DIR/resty/moongoo"
rsync -a -v --checksum --delete-after ./lib/resty/moongoo.lua "$APP_CORE_VENDOR_LUA_SHARE_DIR/resty/moongoo.lua"
rsync -a -v --checksum --delete-after ./lib/resty/moongoo/ "$APP_CORE_VENDOR_LUA_SHARE_DIR/resty/moongoo/"

stamp
